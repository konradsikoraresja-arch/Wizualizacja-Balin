<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wizualizacja pracy filtrów biogazu Balin</title>
    
    <!-- Stylizacja Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel do obsługi JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* --- ANIMACJE --- */
        @keyframes flash-warning {
            0% { fill: #f97316; opacity: 1; }
            50% { fill: #fbbf24; opacity: 0.9; } 
            100% { fill: #f97316; opacity: 1; }
        }
        @keyframes flash-text {
            0% { fill: #dc2626; font-weight: 900; opacity: 1; }
            50% { fill: #991b1b; font-weight: 900; opacity: 0.5; }
            100% { fill: #dc2626; font-weight: 900; opacity: 1; }
        }
        @keyframes flash-filter-inactive {
            0% { fill: #64748b; }
            50% { fill: #94a3b8; }
            100% { fill: #64748b; }
        }
        @keyframes pulse-border-green {
            0% { stroke: #22c55e; stroke-width: 1; }
            50% { stroke: #4ade80; stroke-width: 2; }
            100% { stroke: #22c55e; stroke-width: 1; }
        }
        @keyframes gas-escape {
            0% { transform: translateY(0); opacity: 0.8; }
            100% { transform: translateY(-30px); opacity: 0; }
        }
        .animate-gas-escape { animation: gas-escape 2s infinite; }

        .animate-flash-rect { animation: flash-warning 1s infinite; }
        .animate-flash-text { animation: flash-text 1s infinite; }
        .animate-filter-inactive { animation: flash-filter-inactive 2s infinite; }
        .animate-pulse-green-border { animation: pulse-border-green 2s infinite; }

        .row-active-green { animation: row-pulse-green 1.5s infinite ease-in-out; font-weight: bold; z-index: 10; position: relative; border-left: 4px solid #16a34a; }
        .row-active-purple { animation: row-pulse-purple 1.5s infinite ease-in-out; font-weight: bold; z-index: 10; position: relative; border-left: 4px solid #9333ea; }
        .row-active-orange { animation: row-pulse-orange 1.5s infinite ease-in-out; font-weight: bold; z-index: 10; position: relative; border-left: 4px solid #ea580c; }
        .row-active-red { animation: row-pulse-red 1.5s infinite ease-in-out; font-weight: bold; z-index: 10; position: relative; border-left: 4px solid #dc2626; }

        /* Scrollbary */
        .scada-console::-webkit-scrollbar { width: 8px; }
        .scada-console::-webkit-scrollbar-track { background: #1f2937; }
        .scada-console::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .table-scroll::-webkit-scrollbar { height: 8px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Tabela */
        .cell-ok { color: #166534; font-weight: 800; background-color: #dcfce7; border-radius: 4px; border: 1px solid #86efac; }
        .cell-warn { color: #991b1b; font-weight: 800; background-color: #fee2e2; border-radius: 4px; border: 1px solid #fca5a5; }
        .cell-byp { color: #854d0e; font-weight: 800; background-color: #fef9c3; border-radius: 4px; border: 1px solid #fde047; }
        .scenario-table { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
        .scenario-table th { padding: 10px 4px; font-size: 10px; background-color: #f1f5f9; border-bottom: 2px solid #e2e8f0; color: #475569; text-transform: uppercase; }
        .scenario-table td { padding: 14px 6px; font-size: 11px; border-bottom: 1px solid #e2e8f0; }
        .scenario-table tr { transition: all 0.2s; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .modal-danger { border: 4px solid #dc2626; max-width: 500px; text-align: center; }
        .modal-info { border-top: 4px solid #2563eb; }

        @keyframes row-pulse-green { 0%, 100% { background-color: #bbf7d0; box-shadow: inset 0 0 0 2px #16a34a; transform: scale(1); } 50% { background-color: #86efac; box-shadow: inset 0 0 0 3px #15803d; transform: scale(1.01); } }
        @keyframes row-pulse-purple { 0%, 100% { background-color: #e9d5ff; box-shadow: inset 0 0 0 2px #9333ea; transform: scale(1); } 50% { background-color: #d8b4fe; box-shadow: inset 0 0 0 3px #7e22ce; transform: scale(1.01); } }
        @keyframes row-pulse-orange { 0%, 100% { background-color: #fed7aa; box-shadow: inset 0 0 0 2px #ea580c; transform: scale(1); } 50% { background-color: #fdba74; box-shadow: inset 0 0 0 3px #c2410c; transform: scale(1.01); } }
        @keyframes row-pulse-red { 0%, 100% { background-color: #fecaca; box-shadow: inset 0 0 0 2px #dc2626; transform: scale(1); } 50% { background-color: #fca5a5; box-shadow: inset 0 0 0 3px #b91c1c; transform: scale(1.01); } }
    </style>
</head>
<body class="p-4 flex justify-center min-h-screen">

    <div id="root" class="w-full max-w-[1400px]"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- IKONY ---
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconFileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-700"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-600"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const IconWarningSmall = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-600 mt-0.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const IconDanger = () => <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-600 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const IconBook = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconPause = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>;
        const IconSkipBack = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" y1="19" x2="5" y2="5"/></svg>;
        const IconSkipForward = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19"/></svg>;

        const EnerisLogo = () => (
            <div className="flex items-center gap-4">
                 <img src="logo.png" alt="ENERIS BALIN" className="h-14 object-contain" onError={(e) => {e.target.style.display='none';}} />
                 <div className="text-3xl font-black text-green-700 tracking-tight" style={{fontFamily: 'Verdana, sans-serif'}}>ENERIS BALIN</div>
                 <div className="h-10 w-px bg-slate-300 mx-2"></div>
            </div>
        );

        const valveNames = {
            'f1_in': 'Z1.1 (Wlot F1)', 'f1_out': 'Z1.2 (Wylot F1)', 'f1_byp': 'Z1.3 (Bajpas F1)',
            'f2_in': 'Z2.1 (Wlot F2)', 'f2_out': 'Z2.2 (Wylot F2)', 'f2_byp': 'Z2.3 (Bajpas F2)',
            'f3_in': 'Z3.1 (Wlot F3)', 'f3_out': 'Z3.2 (Wylot F3)', 'f3_byp': 'Z3.3 (Bajpas F3)'
        };

        const mediaExchangeSteps = [
            { id: 0, title: "Praca normalna", desc: "Filtr pracuje. Oba włazy są szczelnie zamknięte.", mediaType: 'dirty', mediaLevel: 100, hatchTop: false, hatchSide: false, bolts: true },
            { id: 1, title: "Odcięcie zaworów", desc: "Zamknij zawory wlotowe i wylotowe, aby odizolować filtr.", mediaType: 'dirty', mediaLevel: 100, hatchTop: false, hatchSide: false, bolts: true },
            { id: 2, title: "Wietrzenie (Otwarcie góry)", desc: "Ostrożnie odkręć śruby i uchyl górny dekiel na 15-20 minut. Pozwól gazom ulecieć.", mediaType: 'dirty', mediaLevel: 100, hatchTop: true, hatchSide: false, bolts: false },
            { id: 3, title: "Otwarcie włazu bocznego", desc: "Po przewietrzeniu odkręć właz boczny.", mediaType: 'dirty', mediaLevel: 100, hatchTop: true, hatchSide: true, bolts: false },
            { id: 4, title: "Wysypywanie do Big Bag", desc: "Złoże wysypuje się grawitacyjnie do worka Big Bag.", mediaType: 'dirty', mediaLevel: 0, hatchTop: true, hatchSide: true, bolts: false },
            { id: 5, title: "Wybieranie ręczne", desc: "Operator wybiera resztki złoża łopatą (narzędzie nieiskrzące).", mediaType: 'empty', mediaLevel: 0, hatchTop: true, hatchSide: true, bolts: false },
            { id: 6, title: "Inspekcja", desc: "Sprawdzenie wnętrza zbiornika i stanu rusztu.", mediaType: 'empty', mediaLevel: 0, hatchTop: true, hatchSide: true, bolts: false },
            { id: 7, title: "Zamknięcie dołu", desc: "Zamknięcie i uszczelnienie włazu bocznego.", mediaType: 'empty', mediaLevel: 0, hatchTop: true, hatchSide: false, bolts: false },
            { id: 8, title: "Zasypywanie", desc: "Zasypanie nowego węgla aktywnego przez właz górny.", mediaType: 'clean', mediaLevel: 100, hatchTop: true, hatchSide: false, bolts: false },
            { id: 9, title: "Zamknięcie góry", desc: "Zamknięcie i uszczelnienie włazu górnego.", mediaType: 'clean', mediaLevel: 100, hatchTop: false, hatchSide: false, bolts: true },
            { id: 10, title: "Uruchomienie", desc: "Przedmuchanie i powolne otwarcie zaworów gazu.", mediaType: 'clean', mediaLevel: 100, hatchTop: false, hatchSide: false, bolts: true }
        ];

        // --- KOMPONENT ANIMACJI WYMIANY ZŁOŻA ---
        const MediaExchangeAnimation = ({ onClose }) => {
            const [step, setStep] = useState(0);
            const [playing, setPlaying] = useState(false);
            
            useEffect(() => {
                let interval;
                if (playing) {
                    interval = setInterval(() => {
                        setStep(prev => {
                            if (prev < mediaExchangeSteps.length - 1) return prev + 1;
                            setPlaying(false);
                            return prev;
                        });
                    }, 3000);
                }
                return () => clearInterval(interval);
            }, [playing]);

            const currentData = mediaExchangeSteps[step];
            const mediaColor = currentData.mediaType === 'dirty' ? '#334155' : '#0f172a';
            // Logic for emptying (step 4) and filling (step 8)
            const animatedHeight = (step === 4) ? 0 : (step === 8 ? 160 : (currentData.mediaLevel === 100 ? 160 : 0));
            const transitionDuration = (step === 4 || step === 8) ? '2.5s' : '0.5s';

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center border-b pb-4 mb-4">
                            <h2 className="text-xl font-bold text-blue-800 flex items-center gap-2">
                                <IconBook /> Instrukcja Wymiany Złoża
                            </h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-red-600 font-bold text-2xl">&times;</button>
                        </div>
                        
                        <div className="flex flex-col md:flex-row gap-6">
                            {/* WIZUALIZACJA FILTRA (Zaktualizowana: rura na szczycie, właz z boku) */}
                            <div className="flex-1 bg-slate-100 rounded-lg p-6 flex justify-center items-center border border-slate-200 relative overflow-hidden" style={{minHeight: '300px'}}>
                                <svg width="200" height="280" viewBox="0 0 200 280">
                                    <defs>
                                        <linearGradient id="tankGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" stopColor="#1e293b" />
                                            <stop offset="50%" stopColor="#334155" />
                                            <stop offset="100%" stopColor="#0f172a" />
                                        </linearGradient>
                                    </defs>
                                    
                                    {/* Nogi */}
                                    <path d="M50 240 L50 270 M150 240 L150 270" stroke="#64748b" strokeWidth="6" />
                                    <rect x="40" y="270" width="20" height="5" fill="#64748b" />
                                    <rect x="140" y="270" width="20" height="5" fill="#64748b" />

                                    {/* Big Bag (tylko przy wysypywaniu i wybieraniu) */}
                                    {(step === 4 || step === 5) && (
                                        <g transform="translate(130, 240)">
                                            <path d="M0 0 L10 40 L50 40 L60 0" fill="#fcd34d" stroke="#b45309" strokeWidth="2" />
                                            <path d="M10 40 L10 50 L50 50 L50 40" fill="#fcd34d" stroke="#b45309" strokeWidth="2" />
                                            <text x="30" y="30" fontSize="8" textAnchor="middle" fill="#78350f" fontWeight="bold">BIG BAG</text>
                                        </g>
                                    )}

                                    {/* Korpus */}
                                    <rect x="50" y="60" width="100" height="180" rx="5" fill="url(#tankGrad)" />
                                    
                                    {/* Stożek dachu */}
                                    <path d="M50 60 L 100 20 L 150 60 Z" fill="#334155" />

                                    {/* Rura (wlot) - centralnie na szczycie */}
                                    <rect x="90" y="0" width="20" height="25" fill="#475569" stroke="#1e293b" />
                                    <rect x="85" y="20" width="30" height="5" fill="#334155" stroke="#1e293b" /> {/* Kołnierz */}

                                    {/* Złoże (Wewnątrz) */}
                                    {currentData.mediaType !== 'empty' && step !== 5 && (
                                        <g transform="translate(55, 235) scale(1, -1)">
                                            <rect width="90" height={animatedHeight} fill={mediaColor} rx="2" style={{transition: `height ${transitionDuration} ease-in-out`}} />
                                            {/* Animacja wysypywania do BigBag */}
                                            {step === 4 && <path d="M90 0 L 110 -20 L 110 -50" stroke="#334155" strokeWidth="8" strokeDasharray="4" className="animate-pulse" />}
                                            {/* Animacja zasypywania */}
                                            {step === 8 && <path d="M45 160 L 70 200" stroke="#0f172a" strokeWidth="12" strokeDasharray="4" className="animate-pulse" />}
                                        </g>
                                    )}

                                    {/* Wietrzenie (Step 2) */}
                                    {step === 2 && (
                                        <g transform="translate(120, 20)">
                                            <path d="M0 0 Q 10 -20 20 -30" stroke="#84cc16" strokeWidth="2" fill="none" className="animate-pulse" />
                                            <path d="M10 0 Q 20 -20 30 -30" stroke="#84cc16" strokeWidth="2" fill="none" className="animate-pulse" style={{animationDelay: '0.5s'}} />
                                        </g>
                                    )}

                                    {/* Wybieranie łopatą (Step 5) */}
                                    {step === 5 && (
                                        <g transform="translate(100, 200)">
                                            <line x1="0" y1="0" x2="30" y2="-20" stroke="#cbd5e1" strokeWidth="3" />
                                            <path d="M-5 0 L 10 0 L 10 10 L -5 10 Z" fill="#94a3b8" />
                                            <text x="0" y="-30" fontSize="10" fill="white">Łopata</text>
                                        </g>
                                    )}

                                    {/* Właz górny - na stożku, pod kątem 45st */}
                                    <g transform="translate(120, 45) rotate(45)">
                                        <rect x="-15" y="-5" width="30" height="10" fill="#475569" stroke="#1e293b" 
                                              className={`transition-all duration-700 ${currentData.hatchTop ? '-translate-y-8 opacity-50' : ''}`} />
                                        <rect x="-20" y="0" width="40" height="5" fill="#334155" /> {/* Kołnierz włazu */}
                                    </g>

                                    {/* Właz boczny */}
                                    <g transform={`translate(150, 200)`}>
                                        <circle cx="0" cy="0" r="15" fill="#475569" stroke="#1e293b" strokeWidth="2" 
                                                className={`transition-all duration-700 ${currentData.hatchSide ? 'translate-x-8 opacity-50' : ''}`} />
                                        {!currentData.hatchSide && currentData.bolts && (
                                            <g fill="#e2e8f0"><circle cx="0" cy="-10" r="2" /><circle cx="0" cy="10" r="2" /><circle cx="-10" cy="0" r="2" /><circle cx="10" cy="0" r="2" /></g>
                                        )}
                                    </g>
                                </svg>
                            </div>

                            {/* OPIS KROKU */}
                            <div className="flex-1 flex flex-col justify-between">
                                <div>
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold">{step + 1}</span>
                                        <h3 className="text-lg font-bold text-slate-800">{currentData.title}</h3>
                                    </div>
                                    <p className="text-slate-600 mb-4">{currentData.desc}</p>
                                    <div className="bg-yellow-50 p-3 rounded border border-yellow-200 text-sm text-yellow-800 mb-4">
                                        <strong>Stan techniczny:</strong>
                                        <ul className="list-disc pl-5 mt-1">
                                            <li>Złoże: {currentData.mediaLevel === 0 ? 'Puste' : (currentData.mediaType === 'dirty' ? 'Zużyte' : 'Nowe')}</li>
                                            <li>Włazy: {currentData.hatchTop ? 'Otwarte' : 'Zamknięte'}</li>
                                        </ul>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 border-t pt-4">
                                    <button onClick={() => setStep(s => Math.max(0, s - 1))} className="p-2 hover:bg-gray-100 rounded" disabled={step===0}><IconSkipBack /></button>
                                    <button onClick={() => setPlaying(!playing)} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded font-bold text-white transition-colors ${playing ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-600 hover:bg-blue-700'}`}>{playing ? <><IconPause /> PAUZA</> : <><IconPlay /> ODTWARZAJ</>}</button>
                                    <button onClick={() => setStep(s => Math.min(mediaExchangeSteps.length - 1, s + 1))} className="p-2 hover:bg-gray-100 rounded" disabled={step===mediaExchangeSteps.length-1}><IconSkipForward /></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- GŁÓWNA APLIKACJA ---
        const ProcessDiagram = () => {
            const [valves, setValves] = useState({ f1_in: true, f1_out: true, f1_byp: false, f2_in: true, f2_out: true, f2_byp: false, f3_in: true, f3_out: true, f3_byp: false });
            const [pumps, setPumps] = useState({ p1: true, p2: false });
            const [maintenanceStatus, setMaintenanceStatus] = useState({ 1: 'IDLE', 2: 'IDLE', 3: 'IDLE' });
            const [logs, setLogs] = useState([]);
            const [pressure, setPressure] = useState(0); 
            const [showBypassWarning, setShowBypassWarning] = useState(false);
            const [showInstruction, setShowInstruction] = useState(false); // Stan modala instrukcji
            const consoleEndRef = useRef(null);

            // --- LOGIKA PRZEPŁYWU ---
            const hasGasInlet = true;
            const isP1Working = hasGasInlet && pumps.p1;
            const isP2Working = hasGasInlet && pumps.p2;
            const hasGasAfterPumps = isP1Working || isP2Working;
            const isGasSupplyStopped = !hasGasAfterPumps;

            const flowIntoF1 = hasGasAfterPumps && valves.f1_in;
            const flowThroughF1 = flowIntoF1 && valves.f1_out;
            const flowBypassF1 = hasGasAfterPumps && valves.f1_byp;
            const hasGasAfterF1 = flowThroughF1 || flowBypassF1;

            const flowIntoF2 = hasGasAfterF1 && valves.f2_in;
            const flowThroughF2 = flowIntoF2 && valves.f2_out;
            const flowBypassF2 = hasGasAfterF1 && valves.f2_byp;
            const hasGasAfterF2 = flowThroughF2 || flowBypassF2;

            const flowIntoF3 = hasGasAfterF2 && valves.f3_in;
            const flowThroughF3 = flowIntoF3 && valves.f3_out;
            const flowBypassF3 = hasGasAfterF2 && valves.f3_byp;
            const hasGasAfterF3 = flowThroughF3 || flowBypassF3;
            
            const hasGasOutlet = hasGasAfterF3;
            const isFlowBlocked = hasGasAfterPumps && !hasGasOutlet;
            
            const f1Isolated = !valves.f1_in && !valves.f1_out;
            const f2Isolated = !valves.f2_in && !valves.f2_out;
            const f3Isolated = !valves.f3_in && !valves.f3_out;

            const addLog = (msg, type = 'info') => {
                const time = new Date().toLocaleTimeString('pl-PL', { hour12: false }) + '.' + String(new Date().getMilliseconds()).padStart(3, '0');
                setLogs(prev => [...prev, { time, msg, type }].slice(-50));
            };

            useEffect(() => { /* Auto-scroll off */ }, [logs]);
            useEffect(() => { addLog("System wizualizacji SCADA uruchomiony.", "system"); }, []);

            useEffect(() => {
                let interval;
                if (hasGasOutlet) {
                    interval = setInterval(() => { setPressure(p => p + (240 + Math.random() * 10 - p) * 0.2); }, 100);
                } else {
                    interval = setInterval(() => { setPressure(p => (p > 1 ? p * 0.8 : 0)); }, 50);
                }
                return () => clearInterval(interval);
            }, [hasGasOutlet]);

            const prevOutletRef = useRef(hasGasOutlet);
            useEffect(() => {
                if (prevOutletRef.current !== hasGasOutlet) {
                    if (hasGasOutlet) addLog("CP1: Wykryto wzrost ciśnienia biogazu. Zasilanie silnika OK.", "success");
                    else addLog("CP1: Spadek ciśnienia biogazu. Brak zasilania silnika.", "error");
                    prevOutletRef.current = hasGasOutlet;
                }
            }, [hasGasOutlet]);

            // --- HANDLERY Z POPRAWIONYM KLIKANIEM ---
            const toggleValve = (id) => {
                const newVal = !valves[id];
                setValves(prev => ({ ...prev, [id]: newVal })); // Natychmiastowa aktualizacja
                addLog(`Operator potwierdził przełączenie zaworu ${valveNames[id]}: ${newVal ? 'OTWARTY' : 'ZAMKNIĘTY'}`, newVal ? 'warning' : 'info');
                
                if (id.endsWith('_byp') && !newVal) {
                    const fId = parseInt(id.charAt(1));
                    if (maintenanceStatus[fId] !== 'IDLE') {
                        setMaintenanceStatus(curr => ({...curr, [fId]: 'IDLE'}));
                        addLog(`Filtr ${fId}: Zakończono procedurę serwisową.`, "success");
                    }
                }
            };

            const togglePump = (id) => {
                const newVal = !pumps[id];
                setPumps(prev => ({ ...prev, [id]: newVal })); 
                const nextP1 = id === 'p1' ? newVal : pumps.p1;
                const nextP2 = id === 'p2' ? newVal : pumps.p2;

                addLog(`Operator przełączył Dmuchawę ${id === 'p1' ? '1' : '2'}: ${newVal ? 'START' : 'STOP'}`, newVal ? 'success' : 'warning');
                if (!nextP1 && !nextP2) addLog("ALARM: Obie dmuchawy STOP. Silnik TEDOM nie może pracować - brak gazu!", "error");
            };

            const advanceMaintenance = (id) => {
                setMaintenanceStatus(prev => {
                    const current = prev[id];
                    if (current === 'IDLE') { addLog(`Filtr ${id}: Potwierdzono tryb serwisowy.`, "warning"); return { ...prev, [id]: 'ACKNOWLEDGED' }; }
                    if (current === 'ACKNOWLEDGED') { addLog(`Filtr ${id}: Rozpoczęto przywracanie do pracy.`, "info"); return { ...prev, [id]: 'RESTORING' }; }
                    return prev;
                });
            };

            const getValveAlert = (valveId) => {
                const match = valveId.match(/f(\d)_(\w+)/);
                if (!match) return null;
                const [_, fIdStr, type] = match;
                const fId = parseInt(fIdStr);
                const status = maintenanceStatus[fId];
                const isValveOpen = valves[valveId];
                if (status === 'ACKNOWLEDGED' && (type === 'in' || type === 'out') && isValveOpen) return ["ZAMKNIJ ZAWÓR RĘCZNIE!", "Potwierdź klikając tutaj"];
                if (status === 'RESTORING') {
                    if ((type === 'in' || type === 'out') && !isValveOpen) return ["OTWÓRZ ZAWÓR RĘCZNIE!", "Potwierdź klikając tutaj"];
                    const inletOpen = valves[`f${fId}_in`], outletOpen = valves[`f${fId}_out`];
                    if (inletOpen && outletOpen && type === 'byp' && isValveOpen) return ["ZAMKNIJ BAJPAS RĘCZNIE!", "Potwierdź klikając tutaj"];
                }
                return null;
            };

            const valveWarnings = useMemo(() => {
                const warnings = [];
                [1, 2, 3].forEach(id => {
                    const i = valves[`f${id}_in`], o = valves[`f${id}_out`], b = valves[`f${id}_byp`], status = maintenanceStatus[id];
                    if (status !== 'RESTORING') {
                        if (i && o && b && status !== 'ACKNOWLEDGED') warnings.push(`Filtr ${id}: Niepotrzebnie otwarty BYPASS. Potwierdź tryb serwisowy.`);
                        else if (i && !o) warnings.push(`Filtr ${id}: Otwarty WLOT, zamknięty WYLOT.`);
                        else if (!i && o) warnings.push(`Filtr ${id}: Otwarty WYLOT, zamknięty WLOT.`);
                    }
                });
                return warnings;
            }, [valves, maintenanceStatus]);

            const currentScenario = useMemo(() => {
                const getStatus = (id) => {
                    const i = valves[`f${id}_in`], o = valves[`f${id}_out`], b = valves[`f${id}_byp`];
                    if (i && o && !b) return { status: 'WORK', label: `F${id}: PRACA`, color: 'text-green-700' };
                    if (!i && !o && b) return { status: 'SERVICE', label: `F${id}: BYPASS`, color: 'text-blue-700' };
                    if (!i && !o && !b) return { status: 'CLOSED', label: `F${id}: ODCIĘTY`, color: 'text-gray-500' };
                    return { status: 'ERROR', label: `F${id}: BŁĄD`, color: 'text-red-600' };
                };
                const s1 = getStatus(1), s2 = getStatus(2), s3 = getStatus(3);
                const hasError = valveWarnings.length > 0;
                let barColor = "bg-white text-gray-800 border-gray-300", scenarioId = 0;
                
                if (hasError) return { text: "UWAGA: WYMAGANA INTERWENCJA OPERATORA", color: "bg-red-100 text-red-800 border-red-300", showIcon: true, id: 0 };

                const wC = [s1, s2, s3].filter(s => s.status === 'WORK').length;
                const bC = [s1, s2, s3].filter(s => s.status === 'SERVICE').length;

                if (wC === 3) { barColor = "bg-green-100 text-green-900 border-green-300"; scenarioId = 1; }
                else if (bC === 3) { barColor = "bg-red-100 text-red-900 border-red-300"; scenarioId = 8; }
                else if (wC === 2 && bC === 1) { 
                    barColor = "bg-blue-50 text-blue-900 border-blue-200"; 
                    if(s1.status==='SERVICE') scenarioId=2; else if(s2.status==='SERVICE') scenarioId=3; else scenarioId=4; 
                }
                else if (wC === 1 && bC === 2) { 
                    barColor = "bg-orange-50 text-orange-900 border-orange-200"; 
                    if(s1.status==='WORK') scenarioId=5; else if(s2.status==='WORK') scenarioId=6; else scenarioId=7; 
                }
                else barColor = "bg-gray-100 text-gray-800 border-gray-300";

                return { text: `${s1.label} | ${s2.label} | ${s3.label}`, color: barColor, showIcon: false, id: scenarioId };
            }, [valves, valveWarnings]);

            useEffect(() => {
                if (currentScenario.id === 8) setShowBypassWarning(true);
            }, [currentScenario.id]);

            // Komponenty
            const Pipe = ({ d, active, thick = 6 }) => <path d={d} fill="none" stroke={active ? "#2563eb" : "#94a3b8"} strokeWidth={thick} strokeLinecap="round" strokeLinejoin="round" className="transition-colors duration-500 ease-in-out" />;
            
            const Valve = ({ x, y, id, isOpen, code, vertical = false, scale = 1, alertLines }) => (
                <g transform={`translate(${x},${y}) scale(${scale})`} onClick={() => toggleValve(id)} className="cursor-pointer hover:opacity-80 transition-opacity group">
                    <circle cx="0" cy="0" r="40" fill="rgba(255,255,255,0.001)" /> {/* FIX KLIKANIA */}
                    <rect x="-18" y="-28" width="36" height="14" rx="2" fill="white" stroke="#cbd5e1" strokeWidth="1" /><text x="0" y="-18" textAnchor="middle" className="text-[9px] font-bold font-mono fill-slate-700 pointer-events-none">{code}</text>
                    <circle r="8" fill={isOpen ? "#bbf7d0" : "#fecaca"} stroke={isOpen ? "#16a34a" : "#dc2626"} strokeWidth="2" />
                    <g transform={`rotate(${isOpen ? (vertical ? 90 : 0) : (vertical ? 0 : 90)})`} className="transition-transform duration-300"><rect x="-12" y="-3" width="24" height="6" rx="2" fill={isOpen ? "#16a34a" : "#dc2626"} stroke="none" /><circle r="2" fill="white" opacity="0.5" /></g>
                    {alertLines && (<g transform="translate(0, 32)"><rect x="-90" y="-12" width="180" height="28" rx="4" fill="white" stroke="#dc2626" strokeWidth="2" className="drop-shadow-lg" /><text x="0" y="-1" textAnchor="middle" fontSize="8" className="animate-flash-text font-black">{alertLines[0]}</text><text x="0" y="9" textAnchor="middle" fontSize="7" className="fill-red-800 font-bold">{alertLines[1]}</text></g>)}
                </g>
            );

            const PumpIso = ({ x, y, active, id, label }) => (
                <g onClick={() => togglePump(id)} className="cursor-pointer group">
                    <rect x={x-30} y={y-20} width="60" height="50" fill="rgba(255,255,255,0.001)" /> {/* FIX KLIKANIA */}
                    <rect x={x-20} y={y-15} width="40" height="30" fill={active ? "#eab308" : "#94a3b8"} stroke={active ? "#854d0e" : "#475569"} strokeWidth="2" rx="2" className="transition-colors duration-300" /><path d={`M ${x+20} ${y-15} L ${x+25} ${y-20} L ${x+25} ${y+10} L ${x+20} ${y+15} Z`} fill={active ? "#ca8a04" : "#64748b"} className="transition-colors duration-300" /><circle cx={x} cy={y} r="10" fill="#1f2937" stroke="#000" />
                    {active && <circle cx={x} cy={y} r="4" fill="#ef4444" className="animate-pulse" />}<rect x={x-25} y={y+15} width="50" height="5" fill="#374151" />
                    <text x={x} y={y-25} textAnchor="middle" className="text-[10px] font-bold fill-slate-600">{label}</text><text x={x} y={y+35} textAnchor="middle" className={`text-[9px] font-bold ${active ? 'fill-green-600' : 'fill-slate-400'}`}>{active ? "ON" : "OFF"}</text>
                </g>
            );

            const LimitSwitch = ({ x, y, active, id, areValvesOpen }) => {
                const isBypassOpen = active;
                const status = maintenanceStatus[id];
                let bgColor = "#16a34a", textPrimary = "SCADA: BAJPAS ZAMKNIĘTY", textSecondary = "", textTertiary = "", showButton = false, btnText = "", animateClass = "", isUrgent = false;
                if (isBypassOpen) {
                    if (status === 'IDLE') { bgColor = "#dc2626"; textPrimary = "SCADA: ZAWÓR OTWARTY!"; textSecondary = "POTWIERDŹ TRYB SERWISOWY"; showButton = true; btnText = "POTWIERDŹ SERWIS"; }
                    else if (status === 'ACKNOWLEDGED') {
                        if (areValvesOpen) { bgColor = "#f97316"; textPrimary = "ZAMKNIJ ZAWORY!"; textSecondary = `Z${id}.1 i Z${id}.2 muszą być zamknięte!`; textTertiary = "ZAMKNIJ RĘCZNIE ZAWORY I POTWIERDŹ KLIKNIĘCIEM"; animateClass = "animate-flash-rect"; isUrgent = true; }
                        else { bgColor = "#3b82f6"; textPrimary = "FILTR ODIZOLOWANY"; textSecondary = "MOŻNA WYMIENIAĆ ZŁOŻE"; showButton = true; btnText = "ZAKOŃCZ SERWIS"; }
                    }
                    else if (status === 'RESTORING') {
                        if (!areValvesOpen) { bgColor = "#f97316"; textPrimary = "KROK 1: OTWÓRZ ZAWORY"; textSecondary = `Z${id}.1 i Z${id}.2 (Otwórz ręcznie i kliknij)`; animateClass = "animate-flash-rect"; }
                        else { bgColor = "#eab308"; textPrimary = "KROK 2: ZAMKNIJ BAJPAS"; textSecondary = `Zamknij ręcznie Z${id}.3 i kliknij go`; animateClass = "animate-flash-rect"; }
                    }
                }
                const boxHeight = (isBypassOpen && textTertiary) ? 90 : (isBypassOpen ? 60 : 25);
                return (
                    <g transform={`translate(${x}, ${y})`}><path d="M 0 0 L 0 -20" stroke="#f59e0b" strokeWidth="2" strokeDasharray="3,2" /><rect x="-12" y="-12" width="24" height="24" fill="#fef3c7" stroke="#d97706" strokeWidth="2" rx="2" /><text x="0" y="4" textAnchor="middle" fontSize="10" fontWeight="bold" fill="#b45309">LS{id}</text><circle cx="0" cy="-20" r="4" fill={active ? "#22c55e" : "#ef4444"} stroke="#fff" strokeWidth="1" />
                    <g transform={`translate(0, -${boxHeight + 25})`}><rect x="-130" y="0" width="260" height={boxHeight} rx="4" fill={bgColor} stroke="white" strokeWidth="1" opacity="0.95" className={`shadow-lg ${animateClass}`} /><text x="0" y="16" textAnchor="middle" fontSize="11" fill="white" fontWeight="bold" style={{textShadow:'0 1px 2px rgba(0,0,0,0.5)'}}>{textPrimary}</text>{textSecondary && <text x="0" y="32" textAnchor="middle" fontSize="10" fill="white">{textSecondary}</text>}{textTertiary && <text x="0" y="50" textAnchor="middle" fontSize="11" fontWeight="bold" fill="white">{textTertiary}</text>}{showButton && <g onClick={(e)=>{e.stopPropagation();advanceMaintenance(id)}} className="cursor-pointer hover:opacity-80" transform={`translate(0, ${boxHeight-20})`}><rect x="-60" y="0" width="120" height="16" rx="8" fill="white"/><text x="0" y="11" textAnchor="middle" fontSize="9" fill="black" fontWeight="bold">{btnText}</text></g>}</g></g>
                );
            };

            const TankIso = ({ x, y, label, isFlowing, isIsolated }) => {
                const w = 60; const h = 100;
                // Logika kolorów: Jeśli przepływa gaz = ciemny, jeśli brak przepływu = szary i miga
                const tankColor = isFlowing ? "#1e293b" : "#64748b"; 
                const animationClass = isFlowing ? "" : "animate-filter-inactive";

                return (
                <g>
                    <ellipse cx={x} cy={y} rx={w/2 + 5} ry="10" fill="black" opacity="0.1" />
                    <path d={`M ${x-20} ${y} L ${x-20} ${y+15}`} stroke="#475569" strokeWidth="4" />
                    <path d={`M ${x+20} ${y} L ${x+20} ${y+15}`} stroke="#475569" strokeWidth="4" />
                    <rect x={x-25} y={y+15} width="10" height="4" fill="#64748b" />
                    <rect x={x+15} y={y+15} width="10" height="4" fill="#64748b" />
                    {/* KORPUS */}
                    <path d={`M ${x-w/2} ${y-h} L ${x-w/2} ${y} A ${w/2} 10 0 0 0 ${x+w/2} ${y} L ${x+w/2} ${y-h}`} 
                          fill={tankColor} stroke="#0f172a" strokeWidth="2" 
                          className={`transition-colors duration-500 ${animationClass}`} />
                    <path d={`M ${x-w/2} ${y-h} L ${x} ${y-h-25} L ${x+w/2} ${y-h}`} fill="#334155" stroke="#0f172a" strokeWidth="2" />
                    <path d={`M ${x-w/2} ${y-h} A ${w/2} 8 0 0 0 ${x+w/2} ${y-h} A ${w/2} 8 0 0 0 ${x-w/2} ${y-h}`} fill="#1e293b" stroke="#0f172a" />
                    <rect x={x-8} y={y-h-35} width="16" height="10" fill="#475569" stroke="black" />
                    <ellipse cx={x} cy={y-h-35} rx="8" ry="3" fill="#94a3b8" stroke="black" />
                    <path d={`M ${x+w/2} ${y-20} L ${x+w/2+10} ${y-20} L ${x+w/2+10} ${y-10} L ${x+w/2} ${y-10}`} fill="#475569" stroke="black" />
                    <ellipse cx={x+w/2+10} cy={y-15} rx="2" ry="5" fill="#64748b" />
                    <text x={x} y={y-h/2} textAnchor="middle" fill="white" opacity="0.5" fontSize="16" fontWeight="bold">{label}</text>
                    {!isFlowing && !isIsolated && <text x={x} y={y-h/2 + 20} textAnchor="middle" fill="#fecaca" fontSize="9" fontWeight="bold">POSTÓJ</text>}
                    
                    {/* KOMUNIKAT NA FILTRZE GDY ODIZOLOWANY */}
                    {isIsolated && (
                        <g transform={`translate(${x}, ${y-h/2 + 20})`}>
                            <rect x="-80" y="-28" width="160" height="56" rx="4" fill="#1e293b" opacity="0.95" stroke="#4ade80" className="animate-pulse-green-border" />
                            <text x="0" y="-12" textAnchor="middle" fill="#4ade80" fontSize="9" fontWeight="bold">MOŻLIWA WYMIANA ZŁOŻA</text>
                            <text x="0" y="2" textAnchor="middle" fill="white" fontSize="8">1. Sprawdź fizycznie zamknięcie</text>
                            <text x="0" y="14" textAnchor="middle" fill="white" fontSize="8">2. Zmierz stężenie detektorem</text>
                        </g>
                    )}
                </g>
                );
            };

            const PressureGauge = ({ x, y, value, max = 300 }) => {
                const angle = -120 + (value / max) * 240;
                return (
                    <g transform={`translate(${x}, ${y})`}><line x1="0" y1="0" x2="0" y2="-15" stroke="#64748b" strokeWidth="3" /><circle cx="0" cy="-35" r="20" fill="white" stroke="#334155" strokeWidth="2" /><path d="M -14 -25 L -10 -28" stroke="#94a3b8" strokeWidth="1" /><path d="M 14 -25 L 10 -28" stroke="#94a3b8" strokeWidth="1" /><path d="M 0 -50 L 0 -46" stroke="#94a3b8" strokeWidth="1" /><g transform={`translate(0, -35) rotate(${angle})`} className="transition-transform duration-100 ease-out"><line x1="0" y1="0" x2="0" y2="-16" stroke="#dc2626" strokeWidth="2" /><circle cx="0" cy="0" r="2" fill="#334155" /></g><text x="0" y="-45" textAnchor="middle" fontSize="6" fill="#64748b" fontWeight="bold">mbar</text><rect x="-12" y="-28" width="24" height="10" fill="#f1f5f9" rx="2" /><text x="0" y="-20" textAnchor="middle" fontSize="8" fill="#0f172a" fontWeight="bold" fontFamily="monospace">{Math.round(value)}</text><rect x="-10" y="-62" width="20" height="10" rx="2" fill="#1e293b" /><text x="0" y="-55" textAnchor="middle" fontSize="7" fill="white" fontWeight="bold">CP1</text></g>
                )
            };

            const TedomEngine = ({ x, y, active }) => (
                <g transform={`translate(${x}, ${y})`}>
                    <rect x="0" y="0" width="130" height="90" rx="4" fill={active ? "#f0fdf4" : "#fef2f2"} stroke={active ? "#16a34a" : "#dc2626"} strokeWidth="2" /><text x="65" y="-30" textAnchor="middle" fontWeight="bold" fill="#334155" fontSize="16">SILNIK TEDOM</text>
                    <rect x="10" y="20" width="110" height="50" fill={active ? "#22c55e" : "#ef4444"} rx="2" className="transition-colors duration-500" /><text x="65" y="52" textAnchor="middle" fill="white" fontWeight="bold" fontSize="12" className="pointer-events-none">{active ? "PRACA" : "BRAK GAZU"}</text>
                    {!active && (<g transform="translate(100, -10)"><circle r="12" fill="#ef4444" stroke="white" strokeWidth="2" /><text x="0" y="4" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold">!</text><animateTransform attributeName="transform" type="scale" values="1;1.2;1" dur="1s" repeatCount="indefinite" additive="sum" /></g>)}
                    <path d="M 90 20 L 90 -25 L 110 -25" fill="none" stroke="#64748b" strokeWidth="6" />{active && <g><circle cx="115" cy="-25" r="4" fill="#94a3b8" opacity="0.6"><animate attributeName="cy" from="-25" to="-65" dur="2s" repeatCount="indefinite" /><animate attributeName="opacity" from="0.6" to="0" dur="2s" repeatCount="indefinite" /><animate attributeName="r" from="4" to="14" dur="2s" repeatCount="indefinite" /></circle><circle cx="115" cy="-25" r="3" fill="#94a3b8" opacity="0.4"><animate attributeName="cy" from="-25" to="-55" dur="2s" begin="0.7s" repeatCount="indefinite" /><animate attributeName="opacity" from="0.4" to="0" dur="2s" begin="0.7s" repeatCount="indefinite" /><animate attributeName="r" from="3" to="10" dur="2s" begin="0.7s" repeatCount="indefinite" /></circle><circle cx="115" cy="-25" r="2" fill="#cbd5e1" opacity="0.5"><animate attributeName="cy" from="-25" to="-45" dur="1.5s" begin="1.2s" repeatCount="indefinite" /><animate attributeName="opacity" from="0.5" to="0" dur="1.5s" begin="1.2s" repeatCount="indefinite" /><animate attributeName="r" from="2" to="8" dur="1.5s" begin="1.2s" repeatCount="indefinite" /></circle></g>}
                </g>
            );

            return (
                <div className="flex flex-col items-center p-6 bg-slate-50 rounded-xl shadow-lg w-full border border-slate-200">
                    <div className="w-full flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-lg shadow-sm border border-slate-100">
                        <div className="flex items-center gap-4"><EnerisLogo /></div>
                        <div className="flex-1 text-center md:text-left md:ml-4">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2 md:justify-start justify-center"><IconSettings />Wizualizacja pracy filtrów biogazu Balin</h2>
                            <div className="flex items-center gap-2 mt-2">
                                <button onClick={() => setShowInstruction(true)} className="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow transition-colors text-sm font-bold"><IconBook /> INSTRUKCJA WYMIANY ZŁOŻA</button>
                                <div className={`inline-flex items-center px-4 py-2 rounded-lg text-sm font-bold border transition-all duration-300 ${(isFlowBlocked || isGasSupplyStopped) ? 'bg-red-600 text-white border-red-800 animate-pulse' : currentScenario.color} shadow-sm gap-2 ml-2`}>
                                    {(currentScenario.showIcon || isFlowBlocked || isGasSupplyStopped) && (<IconAlert className={(isFlowBlocked || isGasSupplyStopped) ? "text-white" : ""} />)}
                                    <span>STATUS UKŁADU: {currentScenario.text}</span>
                                    {isFlowBlocked && (<><span className="w-px h-4 bg-white/40 mx-1"></span><span className="uppercase tracking-wide">KRYTYCZNY BŁĄD: ZAWORY ZAMKNIĘTE - BRAK PRZEPŁYWU</span></>)}
                                    {isGasSupplyStopped && (<><span className="w-px h-4 bg-white/40 mx-1"></span><span className="uppercase tracking-wide">AWARIA: BRAK TŁOCZENIA - DMUCHAWY STOP</span></>)}
                                </div>
                            </div>
                            {valveWarnings.length > 0 && !isFlowBlocked && !isGasSupplyStopped && (<div className="mt-3 bg-red-50 border border-red-200 rounded-lg p-2 text-sm text-red-800 animate-pulse text-left">{valveWarnings.map((warning, idx) => (<div key={idx} className="flex items-start gap-2"><IconWarningSmall /><span>{warning}</span></div>))}</div>)}
                        </div>
                        <div className="flex flex-col items-end gap-2 mt-4 md:mt-0">
                            <div className="font-bold text-slate-500 text-sm mb-1">Resja sp. z o.o.</div>
                            <div className="flex gap-3 text-xs font-bold"><div className="flex items-center gap-1"><div className="w-3 h-3 bg-green-500 rounded-full"></div> OTWARTY</div><div className="flex items-center gap-1"><div className="w-3 h-3 bg-red-500 rounded-full"></div> ZAMKNIĘTY</div></div>
                            <div className="flex gap-3 text-xs font-bold"><div className="flex items-center gap-1"><div className="w-3 h-3 bg-yellow-500 rounded-full"></div> DMUCHAWA ON</div><div className="flex items-center gap-1"><div className="w-3 h-3 bg-slate-400 rounded-full"></div> DMUCHAWA OFF</div></div>
                        </div>
                    </div>

                    <div className="w-full overflow-x-auto bg-white rounded-lg border border-slate-200 p-4 shadow-inner mb-6">
                        <svg viewBox="0 -100 1000 550" className="w-full min-w-[950px]">
                            <path d="M 50 350 L 850 350 L 880 330 L 80 330 Z" fill="#e2e8f0" stroke="#cbd5e1" /><path d="M 50 350 L 50 360 L 850 360 L 850 350" fill="#cbd5e1" stroke="#94a3b8" />
                            <rect x="100" y="360" width="40" height="15" fill="#cbd5e1" /><rect x="300" y="360" width="40" height="15" fill="#cbd5e1" /><rect x="500" y="360" width="40" height="15" fill="#cbd5e1" /><rect x="700" y="360" width="40" height="15" fill="#cbd5e1" />
                            
                            <text x="20" y="245" fontSize="10" fontWeight="bold" fill="#64748b">WLOT</text>
                            <Pipe d="M 10 250 L 40 250" active={hasGasInlet} thick={8} />
                            <Pipe d="M 40 250 L 40 220 L 60 220" active={hasGasInlet} thick={6} /><PumpIso x={80} y={230} active={isP1Working} id="p1" label="DMUCHAWA GAZU 1" /><Pipe d="M 100 220 L 120 220 L 120 240" active={isP1Working} thick={6} />
                            <Pipe d="M 40 250 L 40 280 L 60 280" active={hasGasInlet} thick={6} /><PumpIso x={80} y={290} active={isP2Working} id="p2" label="DMUCHAWA GAZU 2" /><Pipe d="M 100 280 L 120 280 L 120 260" active={isP2Working} thick={6} />
                            <Pipe d="M 120 250 L 140 250 L 140 90 L 160 90" active={hasGasAfterPumps} thick={8} />

                            <Pipe d="M 160 90 L 300 90" active={hasGasAfterPumps && valves.f1_byp} /><Pipe d="M 300 90 L 360 90" active={(hasGasAfterPumps && valves.f1_byp) || (hasGasAfterPumps && valves.f1_in && valves.f1_out)} />
                            <Pipe d="M 160 90 L 160 145" active={hasGasAfterPumps} /><Pipe d="M 160 145 L 230 145 L 230 155" active={hasGasAfterPumps && valves.f1_in} /><Pipe d="M 270 275 L 300 275 L 300 90" active={hasGasAfterPumps && valves.f1_in && valves.f1_out} />
                            <TankIso x={230} y={290} label="F1" isFlowing={flowThroughF1} isIsolated={f1Isolated} />
                            <Valve x={230} y={90} id="f1_byp" isOpen={valves.f1_byp} code="Z1.3" />
                            <LimitSwitch x={230} y={60} active={valves.f1_byp} id="1" areValvesOpen={valves.f1_in || valves.f1_out} />
                            <Valve x={160} y={130} id="f1_in" isOpen={valves.f1_in} code="Z1.1" vertical={true} alertLines={getValveAlert('f1_in')} />
                            <Valve x={300} y={240} id="f1_out" isOpen={valves.f1_out} code="Z1.2" vertical={true} alertLines={getValveAlert('f1_out')} />

                            <Pipe d="M 360 90 L 400 90" active={hasGasAfterF1} thick={8} />

                            <Pipe d="M 400 90 L 540 90" active={hasGasAfterF1 && valves.f2_byp} /><Pipe d="M 540 90 L 600 90" active={(hasGasAfterF1 && valves.f2_byp) || (hasGasAfterF1 && valves.f2_in && valves.f2_out)} />
                            <Pipe d="M 400 90 L 400 145" active={hasGasAfterF1} /><Pipe d="M 400 145 L 470 145 L 470 155" active={hasGasAfterF1 && valves.f2_in} /><Pipe d="M 510 275 L 540 275 L 540 90" active={hasGasAfterF1 && valves.f2_in && valves.f2_out} />
                            <TankIso x={470} y={290} label="F2" isFlowing={flowThroughF2} isIsolated={f2Isolated} />
                            <Valve x={470} y={90} id="f2_byp" isOpen={valves.f2_byp} code="Z2.3" />
                            <LimitSwitch x={470} y={60} active={valves.f2_byp} id="2" areValvesOpen={valves.f2_in || valves.f2_out} />
                            <Valve x={400} y={130} id="f2_in" isOpen={valves.f2_in} code="Z2.1" vertical={true} alertLines={getValveAlert('f2_in')} />
                            <Valve x={540} y={240} id="f2_out" isOpen={valves.f2_out} code="Z2.2" vertical={true} alertLines={getValveAlert('f2_out')} />

                            <Pipe d="M 600 90 L 640 90" active={hasGasAfterF2} thick={8} />

                            <Pipe d="M 640 90 L 780 90" active={hasGasAfterF2 && valves.f3_byp} /><Pipe d="M 780 90 L 820 90" active={(hasGasAfterF2 && valves.f3_byp) || (hasGasAfterF2 && valves.f3_in && valves.f3_out)} />
                            <Pipe d="M 640 90 L 640 145" active={hasGasAfterF2} /><Pipe d="M 640 145 L 710 145 L 710 155" active={hasGasAfterF2 && valves.f3_in} /><Pipe d="M 750 275 L 780 275 L 780 90" active={hasGasAfterF2 && valves.f3_in && valves.f3_out} />
                            <TankIso x={710} y={290} label="F3" isFlowing={flowThroughF3} isIsolated={f3Isolated} />
                            <Valve x={710} y={90} id="f3_byp" isOpen={valves.f3_byp} code="Z3.3" />
                            <LimitSwitch x={710} y={60} active={valves.f3_byp} id="3" areValvesOpen={valves.f3_in || valves.f3_out} />
                            <Valve x={640} y={130} id="f3_in" isOpen={valves.f3_in} code="Z3.1" vertical={true} alertLines={getValveAlert('f3_in')} />
                            <Valve x={780} y={240} id="f3_out" isOpen={valves.f3_out} code="Z3.2" vertical={true} alertLines={getValveAlert('f3_out')} />

                            <Pipe d="M 820 90 L 870 90" active={hasGasOutlet} thick={8} />
                            <PressureGauge x={845} y={90} value={pressure} />
                            <TedomEngine x={870} y={45} active={hasGasOutlet} />
                        </svg>
                        
                        {/* MODAL OSTRZEGAWCZY DLA PEŁNEGO BYPASSU */}
                        {showBypassWarning && (
                            <div className="modal-overlay">
                                <div className="modal-content modal-danger">
                                    <IconDanger />
                                    <h2 className="text-xl font-bold text-red-700 mb-2">UWAGA! PRACA NA PEŁNYM OBEJŚCIU</h2>
                                    <p className="text-gray-700 mb-4 font-semibold">Silnik zasilany jest gazem niefiltrowanym!</p>
                                    <p className="text-sm text-gray-500 mb-6">Praca w tym trybie stwarza poważne ryzyko uszkodzenia podzespołów jednostki kogeneracyjnej Tedom (wtryskiwacze, głowice).</p>
                                    <button onClick={() => setShowBypassWarning(false)} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded transition-colors w-full">ZROZUMIAŁEM RYZYKO</button>
                                </div>
                            </div>
                        )}

                        {/* MODAL INSTRUKCJI */}
                        {showInstruction && (
                            <div className="modal-overlay" onClick={() => setShowInstruction(false)}>
                                <div className="modal-content modal-info text-left" onClick={e => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h2 className="text-xl font-bold text-blue-800 flex items-center gap-2"><IconBook /> PROCEDURA WYMIANY ZŁOŻA WĘGLOWEGO</h2>
                                        <button onClick={() => setShowInstruction(false)} className="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
                                    </div>
                                    <div className="space-y-4">
                                        <MediaExchangeAnimation onClose={() => setShowInstruction(false)} />
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="w-full bg-gray-900 text-green-400 font-mono text-xs p-4 rounded-lg h-48 overflow-hidden flex flex-col shadow-inner border border-gray-700 mb-6">
                        <div className="font-bold border-b border-gray-700 mb-2 pb-1 flex justify-between items-center"><span>TERMINAL SYSTEMOWY SCADA</span><div className="flex gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div><div className="w-2 h-2 rounded-full bg-yellow-500"></div><div className="w-2 h-2 rounded-full bg-green-500"></div></div></div>
                        <div className="scada-console overflow-y-auto flex-1 space-y-1 pr-2">
                            {logs.map((log, i) => (<div key={i} className={`flex gap-2 ${log.type === 'warning' ? 'text-yellow-400' : log.type === 'success' ? 'text-green-400' : log.type === 'error' ? 'text-red-500 font-bold' : 'text-blue-300'}`}><span className="opacity-50">[{log.time}]</span><span>{log.msg}</span></div>))}
                            <div ref={consoleEndRef} />
                        </div>
                    </div>

                    <div className="w-full bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm mb-6">
                        <div className="bg-slate-100 p-3 border-b border-slate-200 flex items-center gap-2"><IconFileText /><h3 className="font-bold text-slate-700">Tabela Scenariuszy (Ściąga)</h3></div>
                        <div className="overflow-x-auto table-scroll">
                            <table className="w-full text-sm text-left scenario-table"><thead className="bg-slate-50 text-slate-600 font-bold border-b"><tr><th className="p-3">Tryb Pracy</th><th className="p-3 text-center">F1 Wlot</th><th className="p-3 text-center">F1 Wylot</th><th className="p-3 text-center">F1 Bypass</th><th className="p-3 text-center">F2 Wlot</th><th className="p-3 text-center">F2 Wylot</th><th className="p-3 text-center">F2 Bypass</th><th className="p-3 text-center">F3 Wlot</th><th className="p-3 text-center">F3 Wylot</th><th className="p-3 text-center">F3 Bypass</th><th className="p-3">Opis</th></tr></thead>
                            <tbody className="divide-y divide-slate-100">
                                <tr className={`hover:bg-slate-50 ${currentScenario.id === 1 ? 'row-active-green' : ''}`}><td className="p-3 font-semibold">1. Normalna Praca</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="p-3 text-gray-600">Pracują F1, F2, F3.</td></tr>
                                <tr className={`hover:bg-slate-50 ${currentScenario.id === 2 ? 'row-active-purple' : ''}`}><td className="p-3 font-semibold">2. Praca F2 i F3 (Serwis F1)</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="p-3 text-gray-600">F1 pominięty.</td></tr>
                                <tr className={`hover:bg-slate-50 ${currentScenario.id === 3 ? 'row-active-purple' : ''}`}><td className="p-3 font-semibold">3. Praca F1 i F3 (Serwis F2)</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="p-3 text-gray-600">F2 pominięty.</td></tr>
                                <tr className={`hover:bg-slate-50 ${currentScenario.id === 4 ? 'row-active-purple' : ''}`}><td className="p-3 font-semibold">4. Praca F1 i F2 (Serwis F3)</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="p-3 text-gray-600">F3 pominięty.</td></tr>
                                <tr className={`hover:bg-slate-50 ${currentScenario.id === 5 ? 'row-active-orange' : ''}`}><td className="p-3 font-semibold">5. Praca F1</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="p-3 text-gray-600">F2 i F3 pominięte.</td></tr>
                                <tr className={`hover:bg-slate-50 ${currentScenario.id === 6 ? 'row-active-orange' : ''}`}><td className="p-3 font-semibold">6. Praca F2</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="p-3 text-gray-600">F1 i F3 pominięte.</td></tr>
                                <tr className={`hover:bg-slate-50 ${currentScenario.id === 7 ? 'row-active-orange' : ''}`}><td className="p-3 font-semibold">7. Praca F3</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-ok">OTW</td><td className="text-center cell-warn">ZAM</td><td className="p-3 text-gray-600">F1 i F2 pominięte.</td></tr>
                                <tr className={`hover:bg-red-100 ${currentScenario.id === 8 ? 'row-active-red' : ''}`}><td className="p-3 font-semibold text-red-900">8. Pełny Bypass</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-warn">ZAM</td><td className="text-center cell-byp">OTW</td><td className="p-3 text-gray-600">Brak filtracji.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProcessDiagram />);
    </script>
</body>
</html>
